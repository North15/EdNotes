!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("katex")):"function"==typeof define&&define.amd?define(["exports","katex"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).EdNotesRichText={},t.katex)}(this,function(t,e){"use strict";const n=new Set(["p","h1","h2","h3","ul","ol","li","blockquote","pre","code","hr","table","thead","tbody","tr","th","td","span"]),r=new Set(["strong","em","u","a"]),o=new Set(["href","target","rel","colspan","rowspan","data-list","data-checked","class"]),i=/^(https?:|mailto:|tel:)/i;function a(t){return t=t.toLowerCase(),n.has(t)||r.has(t)}function s(t){if(!t.getAttribute("href"))return;let e=t.getAttribute("href");const n=e;e=e.trim();try{e=decodeURIComponent(e)}catch(t){}return/^javascript:/i.test(e)?(t.removeAttribute("href"),t.setAttribute("target","_blank"),void t.setAttribute("rel","noopener noreferrer")):i.test(e)?(e!==n&&t.setAttribute("href",e),t.setAttribute("target","_blank"),void t.setAttribute("rel","noopener noreferrer")):(t.removeAttribute("href"),t.setAttribute("target","_blank"),void t.setAttribute("rel","noopener noreferrer"))}function l(t){const e=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null),n=[];for(;e.nextNode();){const t=e.currentNode,r=t.tagName.toLowerCase();if("script"!==r&&"iframe"!==r)if(t.querySelectorAll&&t.querySelectorAll("script,iframe").forEach(t=>t.remove()),a(r)){for(const e of Array.from(t.attributes)){const n=e.name.toLowerCase();"style"!==n&&o.has(n)||t.removeAttribute(e.name)}if(t.getAttribute&&t.getAttribute("style")&&t.removeAttribute("style"),/h[1-6]/.test(r)&&t.getAttribute&&t.getAttribute("style")&&t.removeAttribute("style"),"a"===r&&s(t),"ul"===r&&"task"===t.getAttribute("data-list")&&t.querySelectorAll("li").forEach(t=>{t.hasAttribute("data-checked")||t.setAttribute("data-checked","false")}),"span"===r&&t.classList.contains("math")&&(t.textContent=t.textContent.replace(/[<>&]/g,"")),"table"===r){const e=[...t.children].filter(t=>t.tagName&&"tr"===t.tagName.toLowerCase());if(e.length){let n=t.querySelector("tbody");n||(n=document.createElement("tbody"),t.appendChild(n)),e.forEach(t=>n.appendChild(t))}[...t.querySelectorAll("*")].forEach(t=>{const e=t.tagName.toLowerCase();["table","thead","tbody","tr","th","td"].includes(e)||t.remove()})}}else{if(t.childNodes.length)for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);n.push(t)}else n.push(t)}n.forEach(t=>t.remove()),t.querySelectorAll&&t.querySelectorAll("[style]").forEach(t=>t.removeAttribute("style"))}function c(t,e,n){const r=[];let o=e;for(;o&&o!==t;){const t=o.parentNode;if(!t)break;const e=Array.prototype.indexOf.call(t.childNodes,o);r.push(e),o=t}return{indexes:r,offset:n}}function d(t,e){if(!e)return null;let n=t;const r=[...e.indexes];for(;r.length;){const t=r.shift();if(n=n.childNodes[t],!n)return null}const o="undefined"!=typeof Node&&Node.TEXT_NODE?Node.TEXT_NODE:3;return{node:n,nodeLength:n.nodeType===o?n.textContent.length:n.childNodes.length}}class u{constructor(t){this.editor=t,this._registry=new Map}register(t,e){this._registry.set(t,e)}exec(t,e){const n=this._registry.get(t);if(!n)return!1;if(this.editor._transaction(t=>n(t,e||{})),"noop"!==t&&this.editor._live){const e=t.replace("strong","bold").replace("em","italic").replace("u","underline").replace("block:","heading ").replace("list:","list ").replace("link:","link ");this.editor._live.textContent=`Applied ${e}`}try{let e;"function"==typeof CustomEvent?e=new CustomEvent("rtx-command",{bubbles:!0,detail:{name:t}}):(e=document.createEvent("CustomEvent"),e.initCustomEvent("rtx-command",!0,!1,{name:t})),this.editor.content.dispatchEvent(e)}catch(t){}return!0}}function h(t){return e=>{const n={strong:"bold",em:"italic",u:"underline"};if("function"==typeof document.execCommand&&n[t])try{return void document.execCommand(n[t])}catch(t){}const r=document.getSelection();if(!r||0===r.rangeCount||r.isCollapsed)return;const o=r.getRangeAt(0);let i=o.startContainer;for(;i&&3===i.nodeType;)i=i.parentNode;let a=o.endContainer;for(;a&&3===a.nodeType;)a=a.parentNode;if(i===a&&i&&i.tagName&&i.tagName.toLowerCase()===t){const t=i,e=document.createDocumentFragment();for(;t.firstChild;)e.appendChild(t.firstChild);return void t.parentNode.replaceChild(e,t)}const s=document.createElement(t);s.appendChild(o.extractContents()),o.insertNode(s),r.removeAllRanges();const l=document.createRange();l.selectNodeContents(s),r.addRange(l)}}class p{constructor(t,e){this.textarea=t,this.options=e||{},this.root=this._build(),this.content=this.root.querySelector(".rtx-content"),this.bus=new u(this),this.bus.register("noop",()=>{}),this.history={stack:[],index:-1,batching:!1,lastTypeTs:0,limit:this.options.historyLimit||100},this._setInterval=this.options._setInterval||setInterval,this.options.autosaveIntervalMs&&(this._autosaveTimer=this._setInterval(()=>{const t=this.serialize();this._lastAutosaveValue!==t&&(this._lastAutosaveValue=t,"function"==typeof this.options.onAutosave&&this.options.onAutosave(t))},this.options.autosaveIntervalMs)),this._wire()}_build(){const t=document.createElement("div");t.className="rtx-editor";const e=document.createElement("div");e.className="rtx-toolbar",e.setAttribute("role","toolbar"),e.setAttribute("aria-label","Formatting toolbar");const n=document.createElement("div");n.className="rtx-content",n.contentEditable="true",n.setAttribute("role","textbox"),n.setAttribute("aria-multiline","true");const r=document.createElement("div");return r.className="rtx-live",r.setAttribute("aria-live","polite"),r.style.position="absolute",r.style.left="-9999px",r.style.height="1px",r.style.overflow="hidden",t.appendChild(e),t.appendChild(n),t.appendChild(r),this._live=r,this.textarea.style.display="none",this.textarea.parentNode.insertBefore(t,this.textarea.nextSibling),t}_wire(){this.content.addEventListener("input",()=>{const t=performance.now(),e=t-this.history.lastTypeTs>600;this._transaction(()=>{},{pushHistory:e}),this.history.lastTypeTs=t}),this.content.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData&&t.clipboardData.getData("text/html"),n=t.clipboardData&&t.clipboardData.getData("text/plain");this._transaction(()=>{if(e){const t=document.createElement("div");t.innerHTML=e,l(t),this._insertFragmentAtSelection(t)}else n&&document.execCommand("insertText",!1,n)},{pushHistory:!0})}),this.content.addEventListener("keydown",t=>{const e=t.metaKey||t.ctrlKey,n=t.key.toLowerCase();if(("enter"===n||" "===n)&&!e){const e=document.getSelection();if(e.rangeCount>0){let n=e.anchorNode;for(;n&&n!==this.content;){if(1===n.nodeType&&"li"===n.tagName.toLowerCase()){const e=n.parentNode;if(e&&"ul"===e.tagName.toLowerCase()&&"task"===e.getAttribute("data-list")){t.preventDefault();const e="true"===("true"===n.getAttribute("data-checked")?"true":"false")?"false":"true";return n.setAttribute("data-checked",e),void this._pushHistory()}}n=n.parentNode}}}if(e&&"z"===n)return t.preventDefault(),void(t.shiftKey?this.redo():this.undo());if(e&&("b"===n||"i"===n||"u"===n)){t.preventDefault();const e={b:"strong",i:"em",u:"u"};return void this.bus.exec(e[n])}if(e&&t.altKey&&["0","1","2","3"].includes(t.key)){t.preventDefault();const e={0:"p",1:"h1",2:"h2",3:"h3"};return void this.bus.exec("block:"+e[t.key])}"tab"!==n||this._maybeHandleListIndent(t)}),this.content.innerHTML=this.textarea.value||"<p></p>",this._pushHistory()}_transaction(t,e={}){const n=function(t){const e=document.getSelection();if(!e||0===e.rangeCount)return null;const n=e.getRangeAt(0);return{anchor:c(t,n.startContainer,n.startOffset),focus:c(t,n.endContainer,n.endOffset)}}(this.content);t(this),l(this.content),function(t,e){if(!e)return;const n=document.getSelection();if(!n)return;const r=document.createRange(),o=d(t,e.anchor),i=d(t,e.focus);o&&i&&(r.setStart(o.node,Math.min(e.anchor.offset,o.nodeLength)),r.setEnd(i.node,Math.min(e.focus.offset,i.nodeLength)),n.removeAllRanges(),n.addRange(r))}(this.content,n),this.textarea.value=this.serialize(),"function"==typeof this.options.onChange&&this.options.onChange(this.textarea.value),e.pushHistory&&this._pushHistory()}_pushHistory(){if(this.history.index<this.history.stack.length-1&&(this.history.stack=this.history.stack.slice(0,this.history.index+1)),this.history.stack.push({html:this.serialize()}),this.history.index=this.history.stack.length-1,this.history.stack.length>this.history.limit){const t=this.history.stack.length-this.history.limit;this.history.stack.splice(0,t),this.history.index-=t}}undo(){this.history.index<=0||(this.history.index--,this._restoreHistoryEntry())}redo(){this.history.index>=this.history.stack.length-1||(this.history.index++,this._restoreHistoryEntry())}_restoreHistoryEntry(){const t=this.history.stack[this.history.index];t&&(this.content.innerHTML=t.html,l(this.content),this.textarea.value=this.serialize())}_insertFragmentAtSelection(t){const e=document.getSelection();if(!e||0===e.rangeCount)return;const n=e.getRangeAt(0);for(n.deleteContents();t.firstChild;)n.insertNode(t.firstChild);e.collapse(n.endContainer,n.endOffset)}_maybeHandleListIndent(t){const e=document.getSelection();if(!e||0===e.rangeCount)return!1;let n=e.getRangeAt(0).startContainer;for(;n&&n!==this.content&&3===n.nodeType;)n=n.parentNode;for(;n&&n.tagName&&"li"!==n.tagName.toLowerCase()&&n!==this.content;)n=n.parentNode;if(!n||n===this.content)return!1;const r=n,o=r.parentNode;if(t.shiftKey){const e=o.parentNode&&o.parentNode.tagName&&"li"===o.parentNode.tagName.toLowerCase()?o.parentNode:null;if(t.preventDefault(),e){return e.parentNode.insertBefore(r,e.nextSibling),0===o.children.length&&o.remove(),this._transaction(()=>{},{pushHistory:!0}),!0}return o.parentNode,this.content,!1}{const e=r.previousElementSibling;if(!e)return!1;t.preventDefault();let n=Array.from(e.children).reverse().find(t=>t.tagName&&("ul"===t.tagName.toLowerCase()||"ol"===t.tagName.toLowerCase()));return n||(n=document.createElement(o.tagName.toLowerCase()),e.appendChild(n)),n.appendChild(r),this._transaction(()=>{},{pushHistory:!0}),!0}}serialize(){return this.content.innerHTML}triggerSave(){this.textarea.value=this.serialize()}exportPlainText(){const t=this.content.cloneNode(!0);return t.querySelectorAll("script,style").forEach(t=>t.remove()),t.textContent.replace(/\n{2,}/g,"\n").trim()}exportMarkdown(){const t=[];for(const e of this.content.children){const n=e.tagName.toLowerCase();let r="";if("p"===n)r=e.textContent.trim();else if(/^h[1-6]$/.test(n))r="#".repeat(parseInt(n[1]))+" "+e.textContent.trim();else{if("ul"===n){e.querySelectorAll(":scope > li").forEach(e=>t.push("- "+e.textContent.trim()));continue}if("ol"===n){let n=1;e.querySelectorAll(":scope > li").forEach(e=>t.push(n+++". "+e.textContent.trim()));continue}r=e.textContent.trim()}t.push(r)}return t.join("\n\n")}exportHTML(){return this.content.innerHTML}dispose(){this._autosaveTimer&&clearInterval(this._autosaveTimer)}}const m=new Set;function f(){return Array.from(m)}const g={attach(t,n={}){const r=document.querySelectorAll(t);return 0===r.length?(console.warn("[EdNotes.RichText] No elements matched selector",t),0):(r.forEach(t=>{if(t._rtxAttached)return;t._rtxAttached=!0;const r=new p(t,n);r.bus.register("strong",h("strong")),r.bus.register("em",h("em")),r.bus.register("u",h("u")),r.bus.register("block:p",b("p")),r.bus.register("block:h1",b("h1")),r.bus.register("block:h2",b("h2")),r.bus.register("block:h3",b("h3")),r.bus.register("list:ul",y("ul")),r.bus.register("list:ol",y("ol")),r.bus.register("link:add",function(t){return e=>{const n=document.getSelection();if(!n||0===n.rangeCount)return;const r=t&&t.promptLink?t.promptLink():"function"==typeof window.prompt?window.prompt("Enter URL (https://...)","https://"):null;if(!r)return;const o=document.createElement("a");o.href=r,s(o);const i=n.getRangeAt(0);if(i.collapsed)o.textContent=r,i.insertNode(o),n.collapse(o,o.childNodes.length);else{const t=i.extractContents();o.appendChild(t),i.insertNode(o)}e.bus.exec("noop")}}(n)),r.bus.register("link:remove",t=>{const e=document.getSelection();if(!e||0===e.rangeCount)return;let n=e.anchorNode||e.focusNode;for(;n&&n!==t.content&&(!n.tagName||"a"!==n.tagName.toLowerCase());)n=n.parentNode;if(n&&n.tagName&&"a"===n.tagName.toLowerCase()){const e=n.parentNode;for(;n.firstChild;)e.insertBefore(n.firstChild,n);n.remove(),t._transaction(()=>{},{pushHistory:!0})}}),r.bus.register("list:task",t=>{const e=document.getSelection();if(!e||0===e.rangeCount)return;let n=e.anchorNode;for(;n&&n!==t.content&&3===n.nodeType;)n=n.parentNode;for(;n&&n.parentNode!==t.content;)n=n.parentNode;if(!n)return;const r=n.tagName?n.tagName.toLowerCase():"";if("ul"===r&&"task"===n.getAttribute("data-list"))n.removeAttribute("data-list"),n.querySelectorAll("li").forEach(t=>t.removeAttribute("data-checked"));else if("ul"===r)n.setAttribute("data-list","task"),n.querySelectorAll("li").forEach(t=>{t.hasAttribute("data-checked")||t.setAttribute("data-checked","false")});else{const e=document.createElement("ul");e.setAttribute("data-list","task");const r=document.createElement("li");r.setAttribute("data-checked","false"),r.innerHTML=n.innerHTML||"<br />",e.appendChild(r),t.content.replaceChild(e,n)}}),r.bus.register("math:add",function(t){return n=>{const r=document.getSelection();if(!r||0===r.rangeCount)return;const o=t&&t.promptMath?t.promptMath():"function"==typeof window.prompt?window.prompt("Enter LaTeX:","x^2"):null;if(!o)return;const i=document.createElement("span");i.className="math",i.textContent=o;try{e.render(o,i,{throwOnError:!1})}catch(t){i.textContent="[Math Error]"}const a=r.getRangeAt(0);a.deleteContents(),a.insertNode(i),r.collapse(i.nextSibling||i,0),n.bus.exec("noop")}}(n)),function(t){const e=t.root.querySelector(".rtx-toolbar");if(!e)return;const n=[];[{label:"B",aria:"Bold",cmd:"strong",mark:"strong"},{label:"I",aria:"Italic",cmd:"em",mark:"em"},{label:"U",aria:"Underline",cmd:"u",mark:"u"},{label:"P",aria:"Paragraph",cmd:"block:p",block:"p"},{label:"H1",aria:"Heading 1",cmd:"block:h1",block:"h1"},{label:"H2",aria:"Heading 2",cmd:"block:h2",block:"h2"},{label:"H3",aria:"Heading 3",cmd:"block:h3",block:"h3"},{label:"â€¢",aria:"Bullet List",cmd:"list:ul",list:"ul"},{label:"1.",aria:"Numbered List",cmd:"list:ol",list:"ol"},{label:"ðŸ”—",aria:"Add Link",cmd:"link:add"},{label:"âœ–",aria:"Remove Link",cmd:"link:remove"},{label:"â˜‘",aria:"Task List",cmd:"list:task"},{label:"âˆ‘",aria:"Math Equation",cmd:"math:add"}].forEach((r,o)=>{const i=document.createElement("button");i.type="button",i.textContent=r.label,i.setAttribute("aria-label",r.aria),i.dataset.cmd=r.cmd,i.tabIndex=0===o?0:-1,i.addEventListener("click",()=>t.bus.exec(r.cmd)),i.addEventListener("keydown",t=>{if("ArrowRight"===t.key||"ArrowLeft"===t.key){t.preventDefault();const e="ArrowRight"===t.key?1:-1;let r=n.indexOf(i)+e;r<0&&(r=n.length-1),r>=n.length&&(r=0),n.forEach(t=>t.tabIndex=-1),n[r].tabIndex=0,n[r].focus()}}),e.appendChild(i),n.push(i)})}(r),r.root.setAttribute("data-rtx-attached","true"),t.setAttribute("data-rtx-source","true"),m.add(r)}),r.length)},triggerSave(){m.forEach(t=>t.triggerSave())},undo(){m.forEach(t=>t.undo())},redo(){m.forEach(t=>t.redo())},exportAllPlain:()=>f().map(t=>t.exportPlainText()),exportAllMarkdown:()=>f().map(t=>t.exportMarkdown()),exportAllHTML:()=>f().map(t=>t.exportHTML()),enforceLinkPolicy:s,_all:f,_clearInstances:()=>m.clear()};function b(t){return e=>{const n=document.getSelection();if(!n||0===n.rangeCount)return;let r=n.getRangeAt(0).startContainer;for(;r&&r!==e.content&&3===r.nodeType;)r=r.parentNode;for(;r&&r.parentNode!==e.content;)r=r.parentNode;if(!r)return;if(r.tagName&&r.tagName.toLowerCase()===t)return;const o=document.createElement(t);o.innerHTML=r.innerHTML||"<br />",e.content.replaceChild(o,r)}}function y(t){return e=>{const n=document.getSelection();if(!n||0===n.rangeCount)return;let r=n.getRangeAt(0).startContainer;for(;r&&r!==e.content&&3===r.nodeType;)r=r.parentNode;for(;r&&r.parentNode!==e.content;)r=r.parentNode;if(!r)return;const o=r.tagName?r.tagName.toLowerCase():"";if("ul"===o||"ol"===o){const t=document.createDocumentFragment();Array.from(r.querySelectorAll("li")).forEach(e=>{const n=document.createElement("p");n.innerHTML=e.innerHTML||"<br />",t.appendChild(n)}),e.content.replaceChild(t,r)}else{const n=document.createElement(t),o=document.createElement("li");o.innerHTML=r.innerHTML||"<br />",n.appendChild(o),e.content.replaceChild(n,r)}}}g.version="0.5.0","undefined"!=typeof window&&(window.RichText=g),t.RichText=g});
//# sourceMappingURL=ednotes.richtext.umd.min.js.map
